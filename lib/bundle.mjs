import{redirect as e}from"@sveltejs/kit";import t from"jsonwebtoken";import o from"fs";import r from"yaml";import n from"path";let a,s,i,c,l,d={};const h=()=>{const e=process.env.PWD||process.cwd(),t=n.resolve(e,"tenants.yaml");if(!o.existsSync(t))throw new Error(`TENANT_YAML file not found at path: ${t}`);const a=o.readFileSync(t).toString();try{d=r.parse(a)}catch(e){throw new Error("TENANT_YAML is not valid YAML. err: err")}Object.entries(d).forEach((([e,t])=>{t.name=e}))};h();const m=e=>{if(!e)return!1;const t=e.split("@");if(2!==t.length)return!1;const o=t[0],r=t[1];if(o.length>64)return!1;if(r.length>255)return!1;return!r.split(".").some((function(e){return e.length>63}))&&!!/^[-!#$%&'*+\/0-9=?A-Z^_a-z`{|}~](\.?[-!#$%&'*+\/0-9=?A-Z^_a-z`{|}~])*@[a-zA-Z0-9](-*\.?[a-zA-Z0-9])*\.[a-zA-Z](-?[a-zA-Z0-9])+$/.test(e)},u={getToken:async(e,t,o)=>{const r={grant_type:"authorization_code",username:t,password:o,scope:"openid",client_id:e.client_id,client_secret:e.client_secret},n=new URLSearchParams(Object.entries(r)).toString();try{const t=await fetch(`${a}/realms/${e.realm}/protocol/openid-connect/auth`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n});return JSON.parse(await t.text())}catch(e){throw e}},getLoginForwardUrl:(e,t,o,r)=>{const n={response_type:"code",client_id:e.client_id,redirect_uri:o,response_mode:"jwt",scope:"openid roles email profile",grant_type:"authorization_code",state:t,login_hint:r||""},s=Object.entries(n).map((([e,t])=>`${e}=${encodeURIComponent(t)}`)).join("&");return`${a}/realms/${e.realm}/protocol/openid-connect/auth?${s}`},login:async(e,t,o)=>{const r={grant_type:"password",username:t,password:o,scope:"openid",client_id:e.client_id,client_secret:e.client_secret},n=new URLSearchParams(Object.entries(r)).toString();try{const t=await fetch(`${a}/realms/${e.realm}/protocol/openid-connect/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n});return JSON.parse(await t.text())}catch(e){throw e}},exchangeOneTimeCodeForAccessToken:async(e,t,o)=>{const r={client_id:e.client_id,client_secret:e.client_secret,redirect_uri:`${o.url.origin}${o.url.pathname}`,response_mode:"jwt",scope:"openid",grant_type:"authorization_code",code:t},n=u.convertParmsForBody(r),a=`${s}/realms/${e.realm}/protocol/openid-connect/token`,i=await fetch(a,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n}),c=await i.text();return JSON.parse(c)},refresh:async(e,t)=>{if(!t)throw new Error("No Refresh Token Found");const o={client_id:e.client_id,client_secret:e.client_secret,grant_type:"refresh_token",token_type_hint:"access_token",refresh_token:t},r=new URLSearchParams(Object.entries(o)).toString();try{const t=await fetch(`${s}/realms/${e.realm}/protocol/openid-connect/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r});return JSON.parse(await t.text())}catch(e){throw console.error(`Token Refresh Failed: ${e}}`),e}},logout:async(e,o)=>{var r=t.decode(o);const n={client_id:e.client_id,client_secret:e.client_secret,token_type_hint:"access_token",token:r.sid,grant_type:"refresh_token",refresh_token:o},a=new URLSearchParams(Object.entries(n)).toString();try{return 204===(await fetch(`${s}/realms/${e.realm}/protocol/openid-connect/logout`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:a})).status}catch(e){throw console.error("logout response error"),e}},getByTenantName:e=>{if(!e)throw new Error("Tenant Name undefined");if(!d[e.toLowerCase()])throw new Error(`Tenant ${e} not found`);return d[e.toLowerCase()]},getTenantByEmail:e=>{h();const t=e.split("@")[1].toLowerCase(),o=Object.values(d).filter((e=>e.email_domain===t));if(0===o.length)throw new Error(`No tenant matching ${e} domain`);return o[0]},convertParmsForBody:e=>new URLSearchParams(Object.entries(e)).toString()},p=e=>{["AuthorizationToken","RefreshToken","IdToken","LastPath","csrfCode","tenant"].forEach((t=>{e.cookies.set(t,"",{httpOnly:!0,path:"/",secure:!0,sameSite:"strict",maxAge:0})}))},g=async({event:o,resolve:r})=>{var n,a;console.debug("keycloakservice handle invoked"),console.debug(`event.url: ${o.url}`);const s=o.cookies.get("RefreshToken"),d=o.url.searchParams.get("response");if(o.url.pathname===i&&"POST"===o.request.method&&"?/login"===o.url.search){const t=null===(n=(await o.request.formData()).get("email"))||void 0===n?void 0:n.toString();if(!(!!t&&m(t))||!t)throw console.error(`Invalid email address: ${t}`),e(303,`${i}?err=invalidemail`);const r=o.cookies.get("csrfCode");if(!r)throw console.debug("Redirecting to login if no csrfCode code found"),e(303,i);const a=u.getTenantByEmail(t),s=o.cookies.get("LastPath"),c=`${o.url.origin}${null!=s?s:l}`,d=u.getLoginForwardUrl(a,r,c,t);throw console.debug("Redirecting to keycloak"),e(303,d)}if(!(s||o.url.pathname.startsWith(i)||o.url.pathname.startsWith(c)||d))throw o.cookies.set("LastPath",o.url.pathname,{httpOnly:!0,path:"/",secure:!0,sameSite:"lax",maxAge:600}),console.debug("No refresh token, unauthenticated user, redirecting to login"),e(302,i);if(!s&&o.url.pathname===i&&"GET"===o.request.method){if(!o.cookies.get("csrfCode")){const e=Math.random().toString().substring(2,15);o.cookies.set("csrfCode",e,{httpOnly:!0,path:"/",secure:!0,sameSite:"strict",maxAge:300})}return await r(o)}if(d&&!s){const n=t.decode(d);if(!n.iss)throw console.error('No "iss" in response, reqiured to get tenant/realm.'),e(302,i);try{const e=n.iss.split("/realms/")[1],r=u.getByTenantName(e),a=await u.exchangeOneTimeCodeForAccessToken(r,n.code,o);o.cookies.set("RefreshToken",a.refresh_token,{httpOnly:!0,path:"/",secure:!0,sameSite:"strict",maxAge:a.refresh_expires_in}),o.cookies.set("IdToken",a.id_token,{httpOnly:!0,path:"/",secure:!0,sameSite:"strict",maxAge:36e3});const s=t.decode(a.access_token);o.locals.user={loggedIn:!0,username:s.name,email:s.email,tenant:r.name,roles:s.realm_access.roles}}catch(t){throw console.error("Unable to Obtain Access Code from One-Time-use Code"),console.error(t),p(o),o.locals.user=null,e(302,i)}return await r(o)}if(!s&&o.url.pathname===c)return await r(o);const h=(null!==(a=t.decode(null!=s?s:"").iss)&&void 0!==a?a:"").toLowerCase().split("/realms/")[1],g=u.getByTenantName(h);if(!g)throw p(o),o.locals.user=null,e(302,i);if(s&&-1===[i,c].indexOf(o.url.pathname))try{const n=await u.refresh(g,s);if(o.cookies.set("RefreshToken",n.refresh_token,{httpOnly:!0,path:"/",secure:!0,sameSite:"strict",maxAge:n.refresh_expires_in}),n.error)throw console.error(`KeyCloakService: Token Refresh Failed. Clear cookies return to login page. Message: ${n.error_description}`),o.cookies.set("RefreshToken","",{httpOnly:!0,path:"/",secure:!0,sameSite:"strict",maxAge:0}),o.locals.user=null,e(302,i);const a=t.decode(n.access_token);o.locals.user={loggedIn:!0,username:a.name,email:a.email,tenant:g.name,roles:a.realm_access.roles};return await r(o)}catch(t){throw p(o),o.locals.user=null,e(302,i)}if(s&&o.url.pathname===c){try{await u.logout(g,s)}catch(e){console.error(`Logout Failed! ${e}`)}p(o),o.locals.user=null;const t=Math.random().toString().substring(2,15);throw o.cookies.set("csrfCode",t,{httpOnly:!0,path:"/",secure:!0,sameSite:"strict",maxAge:300}),await r(o),e(302,c)}return await r(o)},w=e=>{var t;return a=e.keycloakUrl,s=e.keycloakInternalUrl,i=e.loginPath,c=e.logoutPath,l=null!==(t=e.postLoginPath)&&void 0!==t?t:"/",g};export{w as KeyCloakHandle,m as emailValidator};
